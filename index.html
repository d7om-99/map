<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>imhere - Abdulrahman Banat</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    * { box-sizing: border-box; }
    html, body {
      height: 100%; margin: 0;
      font-family: 'Segoe UI', sans-serif;
      background-color: #121212;
      color: #fff;
    }
    #container {
      display: flex; height: 100vh;
    }
    #map { flex: 1; z-index: 1; }

    #sidePanel {
      width: 380px;
      background: #1e1e1e;
      display: flex;
      flex-direction: column;
      border-left: 2px solid #00bfa5;
    }
    #tabs {
      display: flex;
      border-bottom: 1px solid #333;
    }
    .tab-btn {
      flex: 1;
      padding: 12px;
      background: transparent;
      border: none;
      color: #aaa;
      font-weight: bold;
      cursor: pointer;
    }
    .tab-btn.active {
      color: #00bfa5;
      border-bottom: 2px solid #00bfa5;
    }
    .tab-content {
      display: none;
      flex: 1;
      overflow-y: auto;
      padding: 12px;
    }
    .tab-content.active { display: block; }

    form input, form textarea, form button, .searchBox {
      width: 100%; padding: 10px; margin: 8px 0;
      border: none; border-radius: 6px;
      background: #2a2a2a;
      color: #fff;
    }
    form button {
      background-color: #00bfa5;
      color: #000;
      font-weight: bold;
      cursor: pointer;
    }
    ul { list-style: none; padding: 0; margin: 0; }
    li {
      background: #2c2c2c;
      padding: 12px;
      margin-bottom: 10px;
      border-radius: 8px;
      cursor: pointer;
    }
    li:hover {
      background: #383838;
    }
    .media-preview {
      margin-top: 8px;
      max-width: 100%;
      border-radius: 6px;
      max-height: 180px;
      object-fit: contain;
    }
    #bottomBar {
      text-align: center;
      background: #00bfa5;
      color: #000;
      padding: 10px;
      font-weight: bold;
    }
    #challengeDetails, #participationForm, #winnerSelection {
      margin-top: 15px;
      background: #222;
      padding: 10px;
      border-radius: 6px;
    }
    #participationForm, #winnerSelection {
      display: none;
    }
    #participationList div {
      margin-bottom: 8px;
      border-bottom: 1px solid #444;
      padding-bottom: 5px;
    }
  </style>
</head>
<body>
  <div id="container">
    <div id="map"></div>
    <aside id="sidePanel">
      <div id="tabs">
        <button class="tab-btn active" data-tab="momentsTab">Moments</button>
        <button class="tab-btn" data-tab="challengesTab">Challenges</button>
        <button class="tab-btn" data-tab="addTab">+ Add</button>
      </div>

      <div class="tab-content active" id="momentsTab">
        <input class="searchBox" id="searchMoments" placeholder="Search moments" />
        <ul id="momentsList"></ul>
      </div>

      <div class="tab-content" id="challengesTab">
        <input class="searchBox" id="searchChallenges" placeholder="Search challenges" />
        <ul id="challengesList"></ul>
        <div id="challengeDetails"></div>
        <div id="participationForm">
          <h4>Participate in Challenge</h4>
          <textarea id="participationComment" placeholder="Your comment or message"></textarea>
          <input type="file" id="participationMedia" accept="image/*,video/*" />
          <button id="submitParticipationBtn">Submit Participation</button>
        </div>
        <div id="winnerSelection">
          <h4>Select Top 3 Winners</h4>
          <div id="participationList"></div>
          <button id="saveWinnersBtn">Save Winners & Update Points</button>
        </div>
      </div>

      <div class="tab-content" id="addTab">
        <h3>Add Moment</h3>
        <form id="momentForm">
          <input type="text" id="momentTitle" placeholder="Title" required />
          <textarea id="momentDescription" placeholder="Description" required></textarea>
          <input type="file" id="momentMedia" accept="image/*,video/*" />
          <button type="submit">Save Moment</button>
        </form>
        <h3>Create Challenge</h3>
        <form id="challengeForm">
          <input type="text" id="challengeTitle" placeholder="Title" required />
          <textarea id="challengeDescription" placeholder="Description"></textarea>
          <input type="file" id="challengeMedia" accept="image/*,video/*" />
          <button type="submit">Create Challenge</button>
        </form>
      </div>
    </aside>
  </div>
  <div id="bottomBar">imhere - Abdulrahman Banat</div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script type="module">
    import { createClient } from 'https://esm.sh/@supabase/supabase-js@2';

    const supabase = createClient(
      'https://kmkvgaonughwdjaaubmt.supabase.co',
      'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imtta3ZnYW9udWdod2RqYWF1Ym10Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTEyMTY0NzIsImV4cCI6MjA2Njc5MjQ3Mn0.-1HbKQCrEdVAlQ5XDHwbogX_AQB7m7r1oPj_7GyqeRk'
    );

    const map = L.map('map').setView([21.3891, 39.8579], 13);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19,
      attribution: '© OpenStreetMap contributors'
    }).addTo(map);

    let tempLatLng = null;
    let tempMarker = null;
    let currentUserId = 1; // مؤقت - لازم تربطه بتسجيل دخولك

    // اختيار موقع بالدبوس على الخريطة بدل التنبيه
    map.on('dblclick', (e) => {
      tempLatLng = e.latlng;
      if (tempMarker) map.removeLayer(tempMarker);
      tempMarker = L.marker(tempLatLng).addTo(map);
    });

    // رفع ملف (صورة/فيديو) للسحابة
    async function uploadMedia(file) {
      const ext = file.name.split('.').pop();
      const fileName = `${Date.now()}.${ext}`;
      const { data, error } = await supabase.storage.from('media').upload(fileName, file, {
        cacheControl: '3600',
        upsert: false
      });
      if (error) throw new Error(error.message);
      return `https://kmkvgaonughwdjaaubmt.supabase.co/storage/v1/object/public/media/${data.path}`;
    }

    // حفظ لحظة جديدة
    async function saveMoment(e) {
      e.preventDefault();
      if (!tempLatLng) return alert('Double-click on the map to select a location.');
      const title = document.getElementById('momentTitle').value;
      const description = document.getElementById('momentDescription').value;
      const file = document.getElementById('momentMedia').files[0];
      let media_url = null;
      if (file) media_url = await uploadMedia(file);

      const { error } = await supabase.from('moments').insert([{
        title, description, lat: tempLatLng.lat, lng: tempLatLng.lng, media_url, user_id: currentUserId
      }]);
      if (error) return alert('Error saving moment: ' + error.message);
      e.target.reset();
      if (tempMarker) {
        map.removeLayer(tempMarker);
        tempMarker = null;
      }
      tempLatLng = null;
      await loadMoments();
      alert('Moment saved successfully!');
    }

    // حفظ تحدي جديد
    async function saveChallenge(e) {
      e.preventDefault();
      if (!tempLatLng) return alert('Double-click on the map to select a location.');
      const title = document.getElementById('challengeTitle').value;
      const description = document.getElementById('challengeDescription').value;
      const file = document.getElementById('challengeMedia').files[0];
      let media_url = null;
      if (file) media_url = await uploadMedia(file);

      const { error } = await supabase.from('challenges').insert([{
        challenge_title: title, challenge_desc: description, lat: tempLatLng.lat, lng: tempLatLng.lng, media_url, user_id: currentUserId
      }]);
      if (error) return alert('Error saving challenge: ' + error.message);
      e.target.reset();
      if (tempMarker) {
        map.removeLayer(tempMarker);
        tempMarker = null;
      }
      tempLatLng = null;
      await loadChallenges();
      alert('Challenge created successfully!');
    }

    // تحميل اللحظات وعرضها بالقائمة مع الدبابيس على الخريطة
    async function loadMoments() {
      const { data, error } = await supabase.from('moments').select('*').order('id', { ascending: false });
      if (error) return alert('Error loading moments: ' + error.message);
      const list = document.getElementById('momentsList');
      list.innerHTML = '';
      data.forEach(m => {
        const li = document.createElement('li');
        li.innerHTML = `<b>${m.title}</b><br>${m.description}${m.media_url ? `<br><img src="${m.media_url}" class="media-preview" />` : ''}`;
        li.onclick = () => map.setView([m.lat, m.lng], 16);
        list.appendChild(li);
        L.marker([m.lat, m.lng]).addTo(map).bindPopup(`<b>${m.title}</b><br>${m.description}${m.media_url ? `<br><img src="${m.media_url}" style="max-width:150px;" />` : ''}`);
      });
    }

    // تحميل التحديات وعرضها بالقائمة مع دبابيس الخريطة
    async function loadChallenges() {
      const { data, error } = await supabase.from('challenges').select('*').order('id', { ascending: false });
      if (error) return alert('Error loading challenges: ' + error.message);
      const list = document.getElementById('challengesList');
      list.innerHTML = '';
      // نظف أقسام التفاصيل والمشاركة والفائزين
      clearChallengeDetails();

      data.forEach(c => {
        const li = document.createElement('li');
        li.innerHTML = `<b>${c.challenge_title}</b><br>${c.challenge_desc}${c.media_url ? `<br><img src="${c.media_url}" class="media-preview" />` : ''}`;
        li.onclick = () => selectChallenge(c);
        list.appendChild(li);
        L.marker([c.lat, c.lng], { icon: L.icon({ iconUrl: 'https://cdn-icons-png.flaticon.com/512/854/854878.png', iconSize: [30, 30] }) })
          .addTo(map)
          .bindPopup(`<b>${c.challenge_title}</b><br>${c.challenge_desc}${c.media_url ? `<br><img src="${c.media_url}" style="max-width:150px;" />` : ''}`);
      });
    }

    // مسح محتوى تفاصيل التحدي والمشاركة والفائزين
    function clearChallengeDetails() {
      document.getElementById('challengeDetails').innerHTML = '';
      document.getElementById('participationForm').style.display = 'none';
      document.getElementById('winnerSelection').style.display = 'none';
      document.getElementById('participationList').innerHTML = '';
      selectedChallenge = null;
      selectedParticipationIds = [];
      winners = [];
    }

    // المتغيرات الخاصة بالتحدي المختار والمشاركات والفائزين
    let selectedChallenge = null;
    let selectedParticipationIds = [];
    let winners = [];

    // عرض تفاصيل التحدي، المشاركين، وإظهار نموذج المشاركة واختيار الفائزين (إذا صاحب التحدي هو currentUser)
    async function selectChallenge(challenge) {
      clearChallengeDetails();
      selectedChallenge = challenge;

      const detailsDiv = document.getElementById('challengeDetails');
      const participations = await loadParticipations(challenge.id);
      const winnerUsers = await loadWinners(challenge.id);

      // حساب النقاط حسب الفائزين
      let winnersHtml = '';
      if (winnerUsers.length) {
        winnersHtml = `<h4>Top Winners:</h4><ol>`;
        winnerUsers.forEach((w, i) => {
          winnersHtml += `<li>${w.user_name} - ${w.points} points</li>`;
        });
        winnersHtml += `</ol>`;
      }

      // تفاصيل التحدي مع المشاركين وعددهم وترتيب الفائزين
      detailsDiv.innerHTML = `
        <h3>${challenge.challenge_title}</h3>
        <p>${challenge.challenge_desc}</p>
        ${challenge.media_url ? `<img src="${challenge.media_url}" class="media-preview" />` : ''}
        <p><b>Participants:</b> ${participations.length}</p>
        ${winnersHtml}
      `;

      // إظهار نموذج المشاركة للجميع
      document.getElementById('participationForm').style.display = 'block';

      // فقط منشئ التحدي يستطيع اختيار الفائزين
      if (challenge.user_id === currentUserId) {
        document.getElementById('winnerSelection').style.display = 'block';
        showParticipationListForWinners(participations);
      }

      // ربط زر المشاركة
      document.getElementById('submitParticipationBtn').onclick = async () => {
        await submitParticipation(challenge.id);
      };

      // ربط زر حفظ الفائزين
      document.getElementById('saveWinnersBtn').onclick = async () => {
        await saveWinners(challenge.id);
      };
    }

    // تحميل مشاركات تحدي من الجدول participation_challenges
    async function loadParticipations(challenge_id) {
      const { data, error } = await supabase
        .from('challenge_participations')
        .select('*')
        .eq('challenge_id', challenge_id)
        .order('created_at', { ascending: false });
      if (error) {
        alert('Error loading participations: ' + error.message);
        return [];
      }
      return data || [];
    }

    // تحميل معلومات الفائزين
    async function loadWinners(challenge_id) {
      const { data, error } = await supabase
        .from('challenge_winners')
        .select('*, user:user_id(name)')
        .eq('challenge_id', challenge_id)
        .order('position', { ascending: true });
      if (error) {
        alert('Error loading winners: ' + error.message);
        return [];
      }
      return data || [];
    }

    // عرض قائمة المشاركات لاختيار الفائزين
    function showParticipationListForWinners(participations) {
      const participationList = document.getElementById('participationList');
      participationList.innerHTML = '';
      selectedParticipationIds = [];

      participations.forEach(p => {
        const div = document.createElement('div');
        div.innerHTML = `
          <input type="checkbox" data-id="${p.id}" />
          <b>${p.comment || '(No comment)'}</b><br>
          ${p.media_url ? `<img src="${p.media_url}" style="max-width: 100px; border-radius: 4px;" />` : ''}
          <br><small>${new Date(p.created_at).toLocaleString()}</small>
        `;
        participationList.appendChild(div);

        div.querySelector('input').addEventListener('change', e => {
          const id = Number(e.target.dataset.id);
          if (e.target.checked) {
            if (selectedParticipationIds.length < 3) {
              selectedParticipationIds.push(id);
            } else {
              e.target.checked = false;
              alert('You can only select up to 3 winners.');
            }
          } else {
            selectedParticipationIds = selectedParticipationIds.filter(x => x !== id);
          }
        });
      });
    }

    // إرسال مشاركة في تحدي مع رفع الوسائط
    async function submitParticipation(challenge_id) {
      const comment = document.getElementById('participationComment').value.trim();
      const file = document.getElementById('participationMedia').files[0];
      let media_url = null;
      if (file) {
        try {
          media_url = await uploadMedia(file);
        } catch (e) {
          alert('Error uploading media: ' + e.message);
          return;
        }
      }
      if (!comment && !media_url) {
        return alert('Please enter a comment or upload media.');
      }

      const { error } = await supabase.from('challenge_participations').insert([{
        challenge_id, user_id: currentUserId, comment, media_url
      }]);
      if (error) return alert('Error submitting participation: ' + error.message);

      alert('Participation submitted!');
      document.getElementById('participationComment').value = '';
      document.getElementById('participationMedia').value = '';
      await selectChallenge(selectedChallenge); // تحديث البيانات
    }

    // حفظ الفائزين وتحديث النقاط
    async function saveWinners(challenge_id) {
      if (selectedParticipationIds.length === 0) {
        return alert('Please select at least one winner.');
      }
      if (selectedParticipationIds.length > 3) {
        return alert('You can select up to 3 winners only.');
      }

      // نقاط الفائزين: 1=100، 2=50، 3=35
      const pointsMap = [100, 50, 35];

      // حذف الفائزين السابقين لهذا التحدي
      const { error: delError } = await supabase.from('challenge_winners').delete().eq('challenge_id', challenge_id);
      if (delError) return alert('Error deleting previous winners: ' + delError.message);

      // إضافة الفائزين الجدد وتحديث النقاط للمستخدمين
      for (let i = 0; i < selectedParticipationIds.length; i++) {
        const participation_id = selectedParticipationIds[i];
        const position = i + 1;
        const points = pointsMap[i];

        // إضافة الفائز
        const { error: winErr } = await supabase.from('challenge_winners').insert([{
          challenge_id, participation_id, position
        }]);
        if (winErr) {
          alert('Error saving winner: ' + winErr.message);
          return;
        }

        // تحديث نقاط المستخدم المرتبط بالمشاركة
        // نحتاج أولًا لجلب user_id للمشاركة
        const { data: partData, error: partErr } = await supabase.from('challenge_participations').select('user_id').eq('id', participation_id).single();
        if (partErr) {
          alert('Error fetching participation user: ' + partErr.message);
          return;
        }
        // جلب النقاط الحالية للمستخدم أو 0
        const { data: pointsData, error: pointsErr } = await supabase.from('users_points').select('points').eq('user_id', partData.user_id).single();
        if (pointsErr && pointsErr.code !== 'PGRST116') { // PGRST116: no rows found
          alert('Error fetching user points: ' + pointsErr.message);
          return;
        }

        let newPoints = points;
        if (pointsData) {
          newPoints += pointsData.points;
          // تحديث النقاط
          const { error: upErr } = await supabase.from('users_points').update({ points: newPoints }).eq('user_id', partData.user_id);
          if (upErr) {
            alert('Error updating user points: ' + upErr.message);
            return;
          }
        } else {
          // إدخال نقاط جديدة للمستخدم
          const { error: insErr } = await supabase.from('users_points').insert([{ user_id: partData.user_id, points: newPoints }]);
          if (insErr) {
            alert('Error inserting user points: ' + insErr.message);
            return;
          }
        }
      }
      alert('Winners saved and points updated!');
      await selectChallenge(selectedChallenge); // تحديث العرض
    }

    // بحث اللحظات
    document.getElementById('searchMoments').addEventListener('input', e => {
      const query = e.target.value.toLowerCase();
      document.querySelectorAll('#momentsList li').forEach(li => {
        li.style.display = li.textContent.toLowerCase().includes(query) ? '' : 'none';
      });
    });

    // بحث التحديات
    document.getElementById('searchChallenges').addEventListener('input', e => {
      const query = e.target.value.toLowerCase();
      document.querySelectorAll('#challengesList li').forEach(li => {
        li.style.display = li.textContent.toLowerCase().includes(query) ? '' : 'none';
      });
    });

    // أزرار التبويبات
    document.querySelectorAll('.tab-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        const tabId = btn.getAttribute('data-tab');
        document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
        document.getElementById(tabId).classList.add('active');
      });
    });

    document.getElementById('momentForm').addEventListener('submit', saveMoment);
    document.getElementById('challengeForm').addEventListener('submit', saveChallenge);

    // تحميل البيانات عند بدء الصفحة
    await loadMoments();
    await loadChallenges();

  </script>
</body>
</html>
