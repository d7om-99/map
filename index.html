<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Memory Map - Interactive Moments & Challenges</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<style>
  html, body {
    height: 100%;
    margin: 0; padding: 0;
  }
  body {
    font-family: Arial, sans-serif;
    background: #121212;
    color: #eee;
    display: flex;
    flex-direction: column;
    height: 100vh;
  }
  header {
    background: #009688;
    padding: 15px;
    font-size: 1.5rem;
    font-weight: bold;
    text-align: center;
  }
  #container {
    flex: 1;
    display: flex;
    overflow: hidden;
  }
  #map {
    flex: 2;
    height: 100%;
  }
  #sidePanel {
    flex: 1;
    background: #222;
    padding: 15px;
    box-sizing: border-box;
    overflow-y: auto;
    display: flex;
    flex-direction: column;
  }
  #sidePanel h2 {
    margin-top: 0;
    margin-bottom: 10px;
    color: #00bfa5;
    text-align: center;
  }
  #searchBar {
    margin-bottom: 10px;
    padding: 6px 8px;
    border-radius: 6px;
    border: none;
    width: 100%;
    background: #333;
    color: #eee;
  }
  #momentsList, #challengesList {
    list-style: none;
    padding: 0;
    margin: 0 0 15px 0;
    flex-grow: 1;
    overflow-y: auto;
  }
  #momentsList li, #challengesList li {
    background: #333;
    margin-bottom: 10px;
    padding: 10px;
    border-radius: 8px;
    cursor: pointer;
    display: flex;
    flex-direction: column;
  }
  .moment-title, .challenge-title {
    font-weight: bold;
  }
  .moment-meta, .challenge-meta {
    font-size: 0.85rem;
    color: #bbb;
    margin: 5px 0;
  }
  .moment-date, .challenge-date {
    font-size: 0.75rem;
    color: #888;
  }
  .moment-actions, .challenge-actions {
    display: flex;
    gap: 5px;
    flex-wrap: wrap;
    margin-top: 8px;
  }
  .btn-small {
    background: #00bfa5;
    border: none;
    border-radius: 6px;
    padding: 4px 6px;
    color: #000;
    font-weight: bold;
    cursor: pointer;
    font-size: 0.85rem;
  }
  .btn-small:hover {
    background: #008f7a;
  }
  #momentForm, #challengeForm {
    display: none;
    flex-direction: column;
    background: #333;
    padding: 15px;
    border-radius: 8px;
    margin-top: 10px;
  }
  #momentForm input, #momentForm textarea,
  #challengeForm input, #challengeForm textarea {
    margin-bottom: 10px;
    padding: 8px;
    border-radius: 6px;
    border: none;
    width: 100%;
    color: #eee;
    background: #555;
  }
  #momentForm input::placeholder, #momentForm textarea::placeholder,
  #challengeForm input::placeholder, #challengeForm textarea::placeholder {
    color: #ccc;
  }
  .moment-media img, .moment-media video {
    max-width: 100%;
    max-height: 150px;
    border-radius: 8px;
    margin-top: 5px;
  }
  .moment-comments, .challenge-comments {
    margin-top: 10px;
    font-size: 0.85rem;
    color: #ccc;
  }
  .comment-date {
    font-size: 0.7rem;
    color: #666;
  }
  #tabs {
    display: flex;
    margin-bottom: 10px;
  }
  #tabs button {
    flex: 1;
    padding: 8px;
    background: #444;
    border: none;
    color: #eee;
    cursor: pointer;
    font-weight: bold;
    border-radius: 6px 6px 0 0;
  }
  #tabs button.active {
    background: #00bfa5;
    color: #000;
  }
  #contentMoments, #contentChallenges {
    flex-grow: 1;
    overflow-y: auto;
  }
</style>
</head>
<body>
<header>Memory Map - Interactive Moments & Challenges</header>
<div id="container">
  <div id="map"></div>
  <aside id="sidePanel">
    <div id="tabs">
      <button id="tabMoments" class="active" onclick="showTab('moments')">Moments</button>
      <button id="tabChallenges" onclick="showTab('challenges')">Challenges</button>
    </div>
    <input id="searchBar" type="text" placeholder="Search by title, date, or series (YYYY-MM-DD)" oninput="searchAll()" />
    
    <div id="contentMoments">
      <button onclick="showRandomMoment()" class="btn-small">üîÄ Random Moment</button>
      <button onclick="showDailyChallenge()" class="btn-small">üìÖ Daily Challenge</button>
      <ul id="momentsList"></ul>
      <form id="momentForm">
        <input type="text" id="title" placeholder="Title" required autocomplete="off"/>
        <textarea id="description" placeholder="Description" autocomplete="off"></textarea>
        <input type="text" id="series" placeholder="Series (optional)" autocomplete="off" />
        <input type="file" id="media" accept="image/*,video/*" multiple />
        <button type="submit" class="btn-small">Save Moment</button>
      </form>
    </div>

    <div id="contentChallenges" style="display:none;">
      <button onclick="showRandomChallenge()" class="btn-small">üîÄ Random Challenge</button>
      <button onclick="addChallengeForm()" class="btn-small">‚ûï Add Challenge</button>
      <ul id="challengesList"></ul>
      <form id="challengeForm">
        <input type="text" id="challengeTitle" placeholder="Challenge Title" required autocomplete="off"/>
        <textarea id="challengeDescription" placeholder="Challenge Description" autocomplete="off"></textarea>
        <input type="text" id="challengeLocation" placeholder="Location Name (optional)" autocomplete="off" />
        <input type="file" id="challengeMedia" accept="image/*,video/*" multiple />
        <button type="submit" class="btn-small">Save Challenge</button>
      </form>
    </div>
  </aside>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
  // ÿßŸÑÿÆÿ±Ÿäÿ∑ÿ© ŸàÿßŸÑÿ•ÿπÿØÿßÿØÿßÿ™
  const map = L.map('map').setView([21.3891, 39.8579], 13);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom: 19,
    attribution: '¬© OpenStreetMap contributors'
  }).addTo(map);

  // ÿ®ŸäÿßŸÜÿßÿ™
  let moments = JSON.parse(localStorage.getItem('memoryMapMoments') || '[]');
  let challenges = JSON.parse(localStorage.getItem('memoryMapChallenges') || '[]');
  let markers = [];
  let tempLatLng = null;
  let tempChallengeLatLng = null;

  // ÿ•ŸÜÿ¥ÿßÿ° ŸÖÿßÿ±ŸÉÿ± ŸàŸÜÿßŸÅÿ∞ÿ© ŸÖŸÜÿ®ÿ´ŸÇÿ© ŸÖÿπ ÿπÿØÿßÿØ ÿßŸÑŸÖÿ¥ÿßŸáÿØÿßÿ™
  function createMarker(item, type = 'moment') {
    const marker = L.marker([item.lat, item.lng]).addTo(map);
    let popupContent = `<b>${item.title || item.challengeTitle}</b><br>${item.description || item.challengeDescription || ''}`;
    if(type === 'moment' && item.series) {
      popupContent += `<br><small>Series: ${item.series}</small>`;
    }
    if(type === 'challenge' && item.location) {
      popupContent += `<br><small>Location: ${item.location}</small>`;
    }
    marker.bindPopup(popupContent);
    marker.on('click', () => {
      if(type === 'moment') {
        item.views = (item.views || 0) + 1;
        saveMoments();
        renderMoments();
      } else if(type === 'challenge') {
        item.views = (item.views || 0) + 1;
        saveChallenges();
        renderChallenges();
      }
    });
    markers.push(marker);
  }

  // ÿ™ŸáŸäÿ¶ÿ© ŸÉŸÑ ÿßŸÑŸÖÿßÿ±ŸÉÿ±ÿßÿ™
  function initMarkers() {
    markers.forEach(m => map.removeLayer(m));
    markers = [];
    moments.forEach(m => createMarker(m, 'moment'));
    challenges.forEach(c => createMarker(c, 'challenge'));
  }

  // ÿπÿ±ÿ∂ ÿßŸÑŸÑÿ≠ÿ∏ÿßÿ™ (ÿ£Ÿà ŸÅŸÑÿ™ÿ± ŸÖÿπŸäŸÜ)
  function renderMoments(filtered = null) {
    const list = document.getElementById('momentsList');
    list.innerHTML = '';
    let data = filtered || moments;
    data.forEach((moment, i) => {
      let mediaHtml = '';
      if (moment.media && moment.media.length) {
        const media = moment.media[0];
        if (media.type.startsWith('image/')) {
          mediaHtml = `<img src="${media.data}" alt="Image" />`;
        } else if (media.type.startsWith('video/')) {
          mediaHtml = `<video controls src="${media.data}"></video>`;
        }
      }
      const commentsHtml = moment.comments?.map(c =>
        `<div>‚Ä¢ ${c.text} <span class="comment-date">(${c.date})</span></div>`
      ).join('') || '';
      const item = document.createElement('li');
      item.innerHTML = `
        <div class="moment-title">${moment.title}</div>
        <div class="moment-meta">
          Date: ${moment.date || new Date(moment.createdAt).toLocaleString()}<br>
          Views: ${moment.views || 0} | Likes: ${moment.likes || 0} | Comments: ${moment.comments?.length || 0}
        </div>
        <div class="moment-media">${mediaHtml}</div>
        <div class="moment-comments">${commentsHtml}</div>
        <div class="moment-actions">
          <button class="btn-small" onclick="likeMoment(${moment.id})">Like</button>
          <button class="btn-small" onclick="commentMoment(${moment.id})">Comment</button>
          <button class="btn-small" onclick="showSeries('${moment.series}')" ${!moment.series ? 'disabled' : ''}>Show Series</button>
        </div>
      `;
      list.appendChild(item);
    });
  }

  // ÿπÿ±ÿ∂ ÿßŸÑÿ™ÿ≠ÿØŸäÿßÿ™ (ÿ£Ÿà ŸÅŸÑÿ™ÿ± ŸÖÿπŸäŸÜ)
  function renderChallenges(filtered = null) {
    const list = document.getElementById('challengesList');
    list.innerHTML = '';
    let data = filtered || challenges;
    data.forEach((challenge, i) => {
      let mediaHtml = '';
      if (challenge.media && challenge.media.length) {
        const media = challenge.media[0];
        if (media.type.startsWith('image/')) {
          mediaHtml = `<img src="${media.data}" alt="Image" />`;
        } else if (media.type.startsWith('video/')) {
          mediaHtml = `<video controls src="${media.data}"></video>`;
        }
      }
      const commentsHtml = challenge.comments?.map(c =>
        `<div>‚Ä¢ ${c.text} <span class="comment-date">(${c.date})</span></div>`
      ).join('') || '';
      const item = document.createElement('li');
      item.innerHTML = `
        <div class="challenge-title">${challenge.challengeTitle}</div>
        <div class="challenge-meta">
          Date: ${challenge.date || new Date(challenge.createdAt).toLocaleString()}<br>
          Views: ${challenge.views || 0} | Likes: ${challenge.likes || 0} | Comments: ${challenge.comments?.length || 0}
        </div>
        <div class="challenge-media">${mediaHtml}</div>
        <div class="challenge-comments">${commentsHtml}</div>
        <div class="challenge-actions">
          <button class="btn-small" onclick="likeChallenge(${challenge.id})">Like</button>
          <button class="btn-small" onclick="commentChallenge(${challenge.id})">Comment</button>
        </div>
      `;
      list.appendChild(item);
    });
  }

  // ÿßŸÑÿ•ÿπÿ¨ÿßÿ® ÿ®ÿßŸÑÿ∞ŸÉÿ±Ÿâ
  function likeMoment(id) {
    const moment = moments.find(m => m.id === id);
    if (!moment) return;
    moment.likes = (moment.likes || 0) + 1;
    saveMoments();
    renderMoments();
  }
  // ÿßŸÑÿ™ÿπŸÑŸäŸÇ ÿπŸÑŸâ ÿßŸÑÿ∞ŸÉÿ±Ÿâ
  function commentMoment(id) {
    const moment = moments.find(m => m.id === id);
    if (!moment) return;
    const text = prompt("Write your comment:");
    if (text) {
      if (!moment.comments) moment.comments = [];
      moment.comments.push({ text, date: new Date().toLocaleString() });
      saveMoments();
      renderMoments();
    }
  }

  // ÿ•ÿπÿ¨ÿßÿ® ÿ®ÿßŸÑÿ™ÿ≠ÿØŸä
  function likeChallenge(id) {
    const challenge = challenges.find(c => c.id === id);
    if (!challenge) return;
    challenge.likes = (challenge.likes || 0) + 1;
    saveChallenges();
    renderChallenges();
  }
  // ÿ™ÿπŸÑŸäŸÇ ÿπŸÑŸâ ÿßŸÑÿ™ÿ≠ÿØŸä
  function commentChallenge(id) {
    const challenge = challenges.find(c => c.id === id);
    if (!challenge) return;
    const text = prompt("Write your comment:");
    if (text) {
      if (!challenge.comments) challenge.comments = [];
      challenge.comments.push({ text, date: new Date().toLocaleString() });
      saveChallenges();
      renderChallenges();
    }
  }

  // ÿ≠ŸÅÿ∏ ÿßŸÑÿ∞ŸÉÿ±Ÿäÿßÿ™
  function saveMoments() {
    localStorage.setItem('memoryMapMoments', JSON.stringify(moments));
  }
  // ÿ≠ŸÅÿ∏ ÿßŸÑÿ™ÿ≠ÿØŸäÿßÿ™
  function saveChallenges() {
    localStorage.setItem('memoryMapChallenges', JSON.stringify(challenges));
  }

  // ÿ™ŸàŸÑŸäÿØ ÿ±ŸÇŸÖ ŸÖÿπÿ±ŸÅ ÿπÿ¥Ÿàÿßÿ¶Ÿä
  function generateId() {
    return Math.floor(Math.random() * 1000000);
  }

  // ÿπÿ±ÿ∂ ÿ≥ŸÑÿ≥ŸÑÿ© ÿßŸÑÿ∞ŸÉÿ±Ÿäÿßÿ™
  function showSeries(seriesName) {
    if (!seriesName) return;
    const filtered = moments.filter(m => m.series === seriesName);
    if (filtered.length === 0) {
      alert('No moments in this series.');
      return;
    }
    renderMoments(filtered);
  }

  // ÿßŸÑÿ®ÿ≠ÿ´ ŸÅŸä ÿßŸÑÿ∞ŸÉÿ±Ÿäÿßÿ™ ŸàÿßŸÑÿ™ÿ≠ÿØŸäÿßÿ™ ŸÖÿπŸãÿß
  function searchAll() {
    const query = document.getElementById('searchBar').value.trim().toLowerCase();
    if (!query) {
      renderMoments();
      renderChallenges();
      return;
    }
    // ŸÅŸÑÿ™ÿ±ÿ© ÿßŸÑÿ∞ŸÉÿ±Ÿäÿßÿ™
    const filteredMoments = moments.filter(m =>
      (m.title && m.title.toLowerCase().includes(query)) ||
      (m.date && m.date.includes(query)) ||
      (m.series && m.series.toLowerCase().includes(query))
    );
    renderMoments(filteredMoments);
    // ŸÅŸÑÿ™ÿ±ÿ© ÿßŸÑÿ™ÿ≠ÿØŸäÿßÿ™
    const filteredChallenges = challenges.filter(c =>
      (c.challengeTitle && c.challengeTitle.toLowerCase().includes(query)) ||
      (c.date && c.date.includes(query)) ||
      (c.location && c.location.toLowerCase().includes(query))
    );
    renderChallenges(filteredChallenges);
  }

  // ÿ•ÿ∏Ÿáÿßÿ± ÿ∞ŸÉÿ±Ÿâ ÿπÿ¥Ÿàÿßÿ¶Ÿäÿ©
  function showRandomMoment() {
    if (moments.length === 0) return alert('No moments available.');
    const index = Math.floor(Math.random() * moments.length);
    const moment = moments[index];
    map.setView([moment.lat, moment.lng], 15);
    const marker = markers.find(m => {
      const latLng = m.getLatLng();
      return latLng.lat === moment.lat && latLng.lng === moment.lng;
    });
    if (marker) marker.openPopup();
  }
  // ÿ•ÿ∏Ÿáÿßÿ± ÿ™ÿ≠ÿØŸä ÿπÿ¥Ÿàÿßÿ¶Ÿä
  function showRandomChallenge() {
    if (challenges.length === 0) return alert('No challenges available.');
    const index = Math.floor(Math.random() * challenges.length);
    const challenge = challenges[index];
    map.setView([challenge.lat, challenge.lng], 15);
    const marker = markers.find(m => {
      const latLng = m.getLatLng();
      return latLng.lat === challenge.lat && latLng.lng === challenge.lng;
    });
    if (marker) marker.openPopup();
  }

  // ÿ™ÿ≠ÿØŸä ŸäŸàŸÖŸä Ÿäÿ™ÿ∫Ÿäÿ± ŸÉŸÑ 3 ÿ£ŸäÿßŸÖ
  const dailyChallenges = [
    "ÿ¥ÿßÿ±ŸÉ ÿµŸàÿ±ÿ© ŸÑŸÖŸÉÿßŸÜŸÉ ÿßŸÑÿ≠ÿßŸÑŸä",
    "ÿßŸÉÿ™ÿ® ÿ¥ÿπŸàÿ±ŸÉ ÿ™ÿ¨ÿßŸá ÿßŸÑÿ≥ŸÖÿßÿ° ÿßŸÑŸäŸàŸÖ",
    "ÿ¥ÿßÿ±ŸÉ ÿµŸàÿ±ÿ© ŸÑÿ£ÿ¥Ÿäÿßÿ¶ŸÉ ÿßŸÑŸÖŸÅÿ∂ŸÑÿ©",
    "ÿßŸÉÿ™ÿ® ŸÇÿµÿ© ŸÇÿµŸäÿ±ÿ© ÿπŸÜ ÿ±ÿ≠ŸÑÿ™ŸÉ ÿßŸÑÿ£ÿÆŸäÿ±ÿ©",
    "ÿ¥ÿßÿ±ŸÉ ÿµŸàÿ±ÿ© ÿ∫ÿ±Ÿàÿ® ÿßŸÑÿ¥ŸÖÿ≥",
    "ÿßŸÉÿ™ÿ® ÿπŸÜ ŸÑÿ≠ÿ∏ÿ© ŸÑÿß ÿ™ŸèŸÜÿ≥Ÿâ",
  ];
  function showDailyChallenge() {
    const startDate = new Date("2025-01-01");
    const now = new Date();
    const diffDays = Math.floor((now - startDate) / (1000*60*60*24));
    const index = diffDays % dailyChallenges.length;
    alert("ÿ™ÿ≠ÿØŸä ÿßŸÑŸÑÿ≠ÿ∏ÿ© ÿßŸÑŸäŸàŸÖ: " + dailyChallenges[index]);
  }

  // ÿ™ÿ®ÿØŸäŸÑ ÿßŸÑÿ™ÿ®ŸàŸäÿ®ÿßÿ™ ÿ®ŸäŸÜ ÿßŸÑŸÑÿ≠ÿ∏ÿßÿ™ ŸàÿßŸÑÿ™ÿ≠ÿØŸäÿßÿ™
  function showTab(tab) {
    document.getElementById('contentMoments').style.display = tab === 'moments' ? 'block' : 'none';
    document.getElementById('contentChallenges').style.display = tab === 'challenges' ? 'block' : 'none';
    document.getElementById('tabMoments').classList.toggle('active', tab === 'moments');
    document.getElementById('tabChallenges').classList.toggle('active', tab === 'challenges');
    searchAll();
  }

  // ŸÅŸàÿ±ŸÖ ÿ•ÿ∂ÿßŸÅÿ© ÿ™ÿ≠ÿØŸä ÿ¨ÿØŸäÿØ
  function addChallengeForm() {
    const form = document.getElementById('challengeForm');
    form.style.display = form.style.display === 'flex' ? 'none' : 'flex';
  }

  // ÿ≠ŸÅÿ∏ ÿ™ÿ≠ÿØŸä ÿ¨ÿØŸäÿØ
  document.getElementById('challengeForm').addEventListener('submit', function(e) {
    e.preventDefault();
    const title = document.getElementById('challengeTitle').value.trim();
    if (!title) {
      alert('Please enter a challenge title.');
      return;
    }
    const description = document.getElementById('challengeDescription').value.trim();
    const locationName = document.getElementById('challengeLocation').value.trim();
    const files = document.getElementById('challengeMedia').files;

    if (!tempChallengeLatLng) {
      alert('Please double-click on the map to choose challenge location.');
      return;
    }

    const readerPromises = Array.from(files).map(file => {
      return new Promise(resolve => {
        const reader = new FileReader();
        reader.onload = () => resolve({ type: file.type, data: reader.result });
        reader.readAsDataURL(file);
      });
    });

    Promise.all(readerPromises).then(media => {
      const newChallenge = {
        id: generateId(),
        challengeTitle: title,
        challengeDescription: description,
        location: locationName || null,
        lat: tempChallengeLatLng.lat,
        lng: tempChallengeLatLng.lng,
        media,
        views: 0,
        likes: 0,
        comments: [],
        createdAt: new Date().toISOString(),
        date: new Date().toLocaleString()
      };
      challenges.push(newChallenge);
      saveChallenges();

      createMarker(newChallenge, 'challenge');
      renderChallenges();

      this.reset();
      this.style.display = 'none';
      tempChallengeLatLng = null;
      alert('Challenge saved!');
    });
  });

  // ÿπŸÜÿØ ÿßŸÑÿ∂ÿ∫ÿ∑ ÿßŸÑŸÖÿ≤ÿØŸàÿ¨ ÿπŸÑŸâ ÿßŸÑÿÆÿ±Ÿäÿ∑ÿ© ŸÑÿ™ÿ≠ÿØŸäÿØ ŸÖŸàŸÇÿπ ÿ•ÿ∂ÿßŸÅÿ© ÿ∞ŸÉÿ±Ÿâ ÿ£Ÿà ÿ™ÿ≠ÿØŸä
  map.on('dblclick', function(e) {
    if(document.getElementById('contentMoments').style.display === 'block') {
      tempLatLng = e.latlng;
      document.getElementById('momentForm').style.display = 'flex';
    } else {
      tempChallengeLatLng = e.latlng;
      alert('Location for new challenge selected. Now fill the challenge form and save.');
    }
  });

  // ÿ®ÿØÿ° ÿßŸÑÿ™ÿ∑ÿ®ŸäŸÇ
  initMarkers();
  renderMoments();
  renderChallenges();
  showTab('moments'); // ÿπÿ±ÿ∂ ÿßŸÑÿ™ÿ®ŸàŸäÿ® ÿßŸÑÿßŸÅÿ™ÿ±ÿßÿ∂Ÿä

</script>
</body>
</html>
